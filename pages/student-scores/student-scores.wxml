<!--pages/student-scores/student-scores.wxml-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header" style="width: 506rpx; display: flex; box-sizing: border-box">
    <view class="student-info">
      <text class="student-name">{{studentInfo.name}}</text>
      <text class="student-number">å­¦å·ï¼š{{studentInfo.studentNumber}}</text>
      <!-- åˆ†äº«æ•°æ®æç¤º -->
      <text class="share-tip" wx:if="{{isSharedData}}">ğŸ“± åˆ†äº«æ•°æ® {{compressionInfo}}</text>
    </view>
    <view class="header-actions">
      <button class="btn-share" bindtap="showShare" style="width: 185rpx; display: block; box-sizing: border-box; left: 0rpx; top: 0rpx">åˆ†äº«æˆç»©</button>
    </view>
  </view>

  <!-- æˆç»©æ¦‚è§ˆ -->
  <view class="score-overview">
    <view class="overview-item">
      <text class="overview-label">æ€»ä½œä¸šæ•°</text>
      <text class="overview-value">{{scoreOverview.totalAssignments}}</text>
    </view>
    <view class="overview-item">
      <text class="overview-label">å·²å®Œæˆ</text>
      <text class="overview-value">{{scoreOverview.completedAssignments}}</text>
    </view>
    <view class="overview-item">
      <text class="overview-label">å¹³å‡åˆ†</text>
      <text class="overview-value">{{scoreOverview.averageScore}}</text>
    </view>
    <view class="overview-item">
      <text class="overview-label">é”™é¢˜æ€»æ•°</text>
      <text class="overview-value error-count">{{scoreOverview.totalErrors}}</text>
    </view>
  </view>

  <!-- ä½œä¸šåˆ—è¡¨ -->
  <view class="assignments-section">
    <view class="section-header">
      <text class="section-title">ä½œä¸šæˆç»©è¯¦æƒ…</text>
      <view class="filter-tabs">
        <text class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}" data-filter="all" bindtap="switchFilter">å…¨éƒ¨</text>
        <text class="filter-tab {{currentFilter === 'completed' ? 'active' : ''}}" data-filter="completed" bindtap="switchFilter">å·²å®Œæˆ</text>
        <text class="filter-tab {{currentFilter === 'pending' ? 'active' : ''}}" data-filter="pending" bindtap="switchFilter">æœªå®Œæˆ</text>
      </view>
    </view>

    <view class="assignments-list">
      <view class="assignment-item" wx:for="{{filteredAssignments}}" wx:key="id">
        <view class="assignment-header" bindtap="toggleAssignmentDetail" data-id="{{item.id}}">
          <view class="assignment-info">
            <text class="assignment-name">{{item.title}}</text>
            <text class="assignment-date">{{item.date}}</text>
          </view>
          <view class="assignment-score">
            <text class="score-text">{{item.totalScore}}/{{item.maxScore}}</text>
            <text class="expand-icon {{item.expanded ? 'expanded' : ''}}">â–¼</text>
          </view>
        </view>

        <!-- è¯¦ç»†å¾—åˆ†æƒ…å†µ -->
        <view class="assignment-detail" wx:if="{{item.expanded}}">
          <view class="score-breakdown">
            <text class="breakdown-title">å¾—åˆ†è¯¦æƒ…ï¼š</text>
            
            <!-- é¢˜ç›®åˆ—è¡¨ -->
            <view class="question-level level-1" wx:for="{{item.questions}}" wx:key="id" wx:for-item="question">
              <view class="question-header" bindtap="toggleQuestionDetail" data-assignment-id="{{item.id}}" data-question-id="{{question.id}}">
                <text class="question-title">{{question.title}}</text>
                <view class="question-score">
                  <text class="score-earned">{{question.calculatedScore || question.score || 0}}</text>
                  <text class="score-separator">/</text>
                  <text class="score-total">{{question.maxScore}}</text>
                  <text class="expand-icon {{question.expanded ? 'expanded' : ''}}">â–¼</text>
                </view>
              </view>

              <!-- å­é¢˜ç›® -->
              <view class="question-level level-2" wx:if="{{question.expanded && question.subQuestions}}" wx:for="{{question.subQuestions}}" wx:key="id" wx:for-item="subQuestion">
                <view class="question-header" bindtap="toggleSubQuestionDetail" data-assignment-id="{{item.id}}" data-question-id="{{question.id}}" data-sub-question-id="{{subQuestion.id}}">
                  <text class="question-title">{{subQuestion.title}}</text>
                  <view class="question-score">
                    <text class="score-earned">{{subQuestion.calculatedScore || subQuestion.score || 0}}</text>
                    <text class="score-separator">/</text>
                    <text class="score-total">{{subQuestion.maxScore}}</text>
                    <text class="expand-icon {{subQuestion.expanded ? 'expanded' : ''}}">â–¼</text>
                  </view>
                </view>

                <!-- å­å­é¢˜ç›® -->
                <view class="question-level level-3" wx:if="{{subQuestion.expanded && subQuestion.subQuestions}}" wx:for="{{subQuestion.subQuestions}}" wx:key="id" wx:for-item="subSubQuestion">
                  <view class="question-header">
                    <text class="question-title">{{subSubQuestion.title}}</text>
                    <view class="question-score">
                      <text class="score-earned">{{subSubQuestion.calculatedScore || subSubQuestion.score || 0}}</text>
                      <text class="score-separator">/</text>
                      <text class="score-total">{{subSubQuestion.maxScore}}</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>

          <!-- é”™é¢˜å±•ç¤º -->
          <view class="wrong-questions" wx:if="{{item.wrongQuestions && item.wrongQuestions.length > 0}}">
            <text class="wrong-title">æœ¬ä½œä¸šé”™é¢˜ï¼š</text>
            <view class="wrong-list">
              <view class="wrong-item" wx:for="{{item.wrongQuestions}}" wx:key="index" wx:for-item="wrongItem">
                <text class="wrong-question">{{wrongItem.questionPath}}</text>
                <text class="wrong-reason" wx:if="{{wrongItem.reason}}">{{wrongItem.reason}}</text>
              </view>
            </view>
          </view>

          <!-- ä½œä¸šè¯¦æƒ…æŒ‰é’® -->
          <view class="assignment-actions">
            <button class="btn-detail" data-assignment-id="{{item.id}}" bindtap="viewAssignmentDetail">æŸ¥çœ‹ä½œä¸šè¯¦æƒ…</button>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- é”™é¢˜æ±‡æ€» -->
  <view class="errors-summary" wx:if="{{wrongQuestions.length > 0}}">
    <view class="section-header">
      <text class="section-title">é”™é¢˜æ±‡æ€»</text>
      <view class="error-statistics">
        <text class="error-count">å…±{{wrongQuestions.length}}é“é”™é¢˜</text>
        <view class="level-stats">
          <text class="level-stat level1" wx:if="{{errorStats.level1 > 0}}">ä¸€çº§: {{errorStats.level1}}</text>
          <text class="level-stat level2" wx:if="{{errorStats.level2 > 0}}">äºŒçº§: {{errorStats.level2}}</text>
          <text class="level-stat level3" wx:if="{{errorStats.level3 > 0}}">ä¸‰çº§: {{errorStats.level3}}</text>
        </view>
      </view>
    </view>
    
    <view class="errors-list">
      <view class="error-item {{item.level}}" wx:for="{{wrongQuestions}}" wx:key="index">
        <view class="error-header">
          <text class="error-assignment">{{item.assignmentTitle}}</text>
          <view class="error-question-container">
            <text class="level-indicator {{item.level}}">{{item.levelText}}</text>
            <text class="error-question">{{item.questionPath}}</text>
          </view>
        </view>
        <text class="error-reason" wx:if="{{item.reason}}">é”™è¯¯åŸå› ï¼š{{item.reason}}</text>
        <view class="error-score">
          <text class="score-lost">å¤±åˆ†ï¼š{{item.lostScore}}åˆ†</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{filteredAssignments.length === 0}}">
    <text class="empty-text">æš‚æ— æˆç»©è®°å½•</text>
  </view>
</view>

<!-- åˆ†äº«å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showShareModal}}" bindtap="hideShare">
  <view class="modal-content share-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">åˆ†äº«æˆç»©</text>
      <text class="modal-close" bindtap="hideShare">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="share-options">
        <button class="share-option" bindtap="shareToWeChat">
          <text class="share-icon">ğŸ“±</text>
          <text class="share-text">å¾®ä¿¡åˆ†äº«</text>
        </button>
        <button class="share-option" bindtap="copyText">
          <text class="share-icon">ğŸ“‹</text>
          <text class="share-text">å¤åˆ¶æ–‡æœ¬</text>
        </button>
        <button class="share-option" bindtap="saveImage">
          <text class="share-icon">ğŸ–¼ï¸</text>
          <text class="share-text">ä¿å­˜å›¾ç‰‡</text>
        </button>
      </view>
    </view>
  </view>
</view>

<!-- éšè—çš„canvasç”¨äºç”Ÿæˆå›¾ç‰‡ -->
<canvas 
  id="scoreCanvas" 
  type="2d" 
  style="position: fixed; top: -9999px; left: -9999px; width: 375px; height: 900px;"
></canvas>