<!--students.wxml-->
<view class="container">
  <!-- 页面头部 -->
  <view class="header" style="height: 193rpx; display: flex; box-sizing: border-box; position: relative; left: 0rpx; top: -152rpx">
    <!-- 班级信息区域 -->
    <view class="header-info" style="height: 102rpx; display: flex; box-sizing: border-box">
      <text class="current-class">当前班级：{{currentClassName}}</text>
      <text class="student-count">共{{students.length}}个学生</text>
    </view>
    <!-- 操作按钮区域 -->
    <view class="header-actions">
      <button class="btn-secondary" bindtap="showImportModal" style="width: 231rpx; height: 81rpx; display: flex; box-sizing: border-box; left: -18rpx; top: -2rpx; position: relative">批量导入</button>
      <button class="btn-primary" bindtap="showAddModal" style="height: 77rpx; display: flex; box-sizing: border-box; left: 39rpx; top: 2rpx; position: relative">新建学生</button>
    </view>
  </view>

  <!-- 搜索栏 -->
  <view class="search-bar">
    <input style="position: relative; left: -20rpx; top: -2rpx" 
      class="search-input" 
      placeholder="搜索学生姓名或学号"
      value="{{searchKeyword}}"
      bindinput="onSearchInput"
      bindconfirm="onSearch"
    />
    <button class="search-btn" bindtap="onSearch" style="width: 218rpx; display: flex; box-sizing: border-box; left: 0rpx; top: 0rpx">搜索</button>
  </view>

  <!-- 学生列表 -->
  <view class="student-list" wx:if="{{filteredStudents.length > 0}}">
    <view class="student-item" wx:for="{{filteredStudents}}" wx:key="id">
      <view class="student-info">
        <view class="student-name">{{item.name}}</view>
        <view class="student-number">学号：{{item.studentNumber || '未设置'}}</view>
        <view class="student-meta">
          <text class="student-date">创建时间：{{item.createdAt}}</text>
          <text class="student-scores" wx:if="{{item.stats}}">
            已批改作业：{{item.stats.gradedCount}}个
          </text>
        </view>
      </view>
      <view class="student-actions">
        <button class="btn-secondary" data-id="{{item.id}}" bindtap="viewStudentScores">成绩</button>
        <button class="btn-secondary" data-id="{{item.id}}" bindtap="editStudent">编辑</button>
        <button class="btn-danger" data-id="{{item.id}}" bindtap="deleteStudent">删除</button>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:else>
    <text class="empty-text">{{searchKeyword ? '未找到匹配的学生' : '暂无学生'}}</text>
    <button class="btn-primary" bindtap="showAddModal" wx:if="{{!searchKeyword}}">添加第一个学生</button>
  </view>

  <!-- 新建/编辑学生弹窗 -->
  <view class="modal" wx:if="{{showModal}}" bindtap="hideModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{isEdit ? '编辑学生' : '新建学生'}}</text>
        <text class="modal-close" bindtap="hideModal">×</text>
      </view>
      
      <view class="modal-body">
        <view class="form-group">
          <label class="form-label">学生姓名 *</label>
          <input 
            class="form-input" 
            placeholder="请输入学生姓名"
            value="{{formData.name}}"
            data-field="name"
            bindinput="onInputChange"
          />
        </view>

        <view class="form-group">
          <label class="form-label">学号</label>
          <input 
            class="form-input" 
            placeholder="请输入学号（可选）"
            value="{{formData.studentNumber}}"
            data-field="studentNumber"
            bindinput="onInputChange"
          />
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn-secondary" bindtap="hideModal">取消</button>
        <button class="btn-primary" bindtap="handleSubmit">{{isEdit ? '更新' : '创建'}}</button>
      </view>
    </view>
  </view>

  <!-- 批量导入弹窗 -->
  <view class="modal" wx:if="{{showImportModal}}" bindtap="hideImportModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">批量导入学生</text>
        <text class="modal-close" bindtap="hideImportModal">×</text>
      </view>
      
      <view class="modal-body">
        <view class="import-instructions">
          <text class="instruction-title">导入说明：</text>
          <text class="instruction-item">• 每行一个学生，格式：姓名,学号</text>
          <text class="instruction-item">• 学号可以省略，格式：姓名</text>
          <text class="instruction-item">• 示例：张三,20230001</text>
          <text class="instruction-item">• 示例：李四</text>
        </view>

        <view class="form-group">
          <label class="form-label">学生信息</label>
          <textarea 
            class="form-textarea" 
            placeholder="请输入学生信息，每行一个学生&#10;格式：姓名,学号&#10;&#10;张三,20230001&#10;李四,20230002&#10;王五"
            value="{{importData}}"
            bindinput="onImportDataChange"
          />
        </view>

        <view class="import-preview" wx:if="{{previewStudents.length > 0}}">
          <text class="preview-title">预览（{{previewStudents.length}}个学生）：</text>
          <view class="preview-list">
            <view class="preview-item" wx:for="{{previewStudents}}" wx:key="index">
              <text class="preview-name">{{item.name}}</text>
              <text class="preview-number">{{item.studentNumber || '无学号'}}</text>
            </view>
          </view>
        </view>

        <view class="import-errors" wx:if="{{importErrors.length > 0}}">
          <text class="error-title">错误信息：</text>
          <view class="error-list">
            <text class="error-item" wx:for="{{importErrors}}" wx:key="index">第{{item.line}}行：{{item.message}}</text>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn-secondary" bindtap="hideImportModal">取消</button>
        <button class="btn-primary" bindtap="handleImport" disabled="{{previewStudents.length === 0}}">
          导入{{previewStudents.length}}个学生
        </button>
      </view>
    </view>
  </view>
</view>