<!--score-view.wxml-->
<view class="container">
  <!-- 页面头部 -->
  <view class="header">
    <view class="assignment-info">
      <view class="assignment-name">{{assignmentInfo.name}}</view>
      <view class="assignment-meta">
        <text class="type">{{assignmentInfo.type}}</text>
        <text class="questions">{{assignmentInfo.questionCount}}题</text>
        <text class="date">{{assignmentInfo.createdAt}}</text>
      </view>
    </view>
    <view class="stats-info">
      <view class="stat-item">
        <text class="stat-value">{{statistics.gradedCount}}/{{statistics.totalCount}}</text>
        <text class="stat-label">已批改</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{statistics.averageScore}}</text>
        <text class="stat-label">平均分</text>
      </view>
    </view>
  </view>

  <!-- 筛选和排序 -->
  <view class="filter-section">
    <view class="filter-buttons">
      <button class="filter-btn {{filterType === 'all' ? 'active' : ''}}" 
              bindtap="onFilterChange" data-type="all">全部</button>
      <button class="filter-btn {{filterType === 'graded' ? 'active' : ''}}" 
              bindtap="onFilterChange" data-type="graded">已批改</button>
      <button class="filter-btn {{filterType === 'ungraded' ? 'active' : ''}}" 
              bindtap="onFilterChange" data-type="ungraded">未批改</button>
    </view>
    
    <picker class="sort-picker" range="{{sortOptions}}" value="{{sortType}}" bindchange="onSortChange">
      <view class="sort-button">
        <text>{{sortOptions[sortType]}}</text>
        <text class="sort-icon">▼</text>
      </view>
    </picker>
  </view>

  <!-- 成绩列表 -->
  <view class="score-list" wx:if="{{filteredScores.length > 0}}">
    <view class="score-item" wx:for="{{filteredScores}}" wx:key="id" bindtap="onScoreDetail" data-score="{{item}}">
      <view class="student-info">
        <view class="student-name">{{item.studentName}}</view>
        <view class="student-number">{{item.studentNumber}}</view>
      </view>
      
      <view class="score-info" wx:if="{{item.isGraded}}">
        <view class="total-score">{{item.totalScore}}分</view>
        <view class="score-details" wx:if="{{showDetails}}">
          <!-- 标准计分详情 -->
          <view class="sub-scores" wx:if="{{assignmentInfo.scoringMode === 'standard' && assignmentInfo.hasSubQuestions}}">
            <text class="sub-score" wx:for="{{item.subScores}}" wx:key="index" wx:for-item="subScore">
              第{{index + 1}}题: {{subScore}}分
            </text>
          </view>
          
          <!-- 自定义计分详情 -->
          <view class="question-scores" wx:if="{{assignmentInfo.scoringMode === 'custom'}}">
            <text class="question-score" wx:for="{{item.questionScores}}" wx:key="index" wx:for-item="qScore">
              第{{index + 1}}题: {{qScore}}分
            </text>
          </view>
        </view>
        
        <view class="comment" wx:if="{{item.comment}}">
          <text class="comment-label">评语：</text>
          <text class="comment-text">{{item.comment}}</text>
        </view>
        
        <view class="score-meta">
          <text class="graded-time">{{item.gradedTime}}</text>
        </view>
      </view>
      
      <view class="ungraded-info" wx:else>
        <view class="ungraded-status">未批改</view>
        <button class="grade-btn" bindtap="onGradeStudent" data-student="{{item}}">
          批改
        </button>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{filteredScores.length === 0}}" style="width: 627rpx; display: block; box-sizing: border-box">
    <view class="empty-icon">📊</view>
    <view class="empty-text">{{emptyText}}</view>
    <button class="start-grade-btn" wx:if="{{filterType === 'ungraded'}}" bindtap="onStartGrading">
      开始批改
    </button>
  </view>

  <!-- 统计图表 -->
  <view class="charts-section" wx:if="{{statistics.gradedCount > 0}}">
    <view class="section-title">成绩分析</view>
    
    <!-- 分数分布 -->
    <view class="chart-item">
      <view class="chart-title">分数分布</view>
      <view class="distribution-chart">
        <view class="distribution-bar" wx:for="{{scoreDistribution}}" wx:key="range">
          <view class="bar-label">{{item.range}}</view>
          <view class="bar-container">
            <view class="bar-fill" style="width: {{item.percentage}}"></view>
          </view>
          <view class="bar-count">{{item.count}}人</view>
        </view>
      </view>
    </view>
    
    <!-- 排名榜 -->
    <view class="chart-item">
      <view class="chart-title">成绩排名</view>
      <view class="ranking-list">
        <view class="ranking-item" wx:for="{{topStudents}}" wx:key="id">
          <view class="rank-number rank-{{index < 3 ? index + 1 : 'other'}}">{{index + 1}}</view>
          <view class="rank-student">
            <view class="rank-name">{{item.studentName}}</view>
            <view class="rank-number-text">{{item.studentNumber}}</view>
          </view>
          <view class="rank-score">{{item.totalScore}}分</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 操作按钮 -->
  <view class="action-buttons">
    <button class="action-btn" bindtap="onToggleDetails">
      {{showDetails ? '隐藏详情' : '显示详情'}}
    </button>
    <button class="action-btn primary" bindtap="onExportScores">
      导出成绩
    </button>
  </view>
</view>