<!--assignments.wxml-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <!-- ç­çº§ä¿¡æ¯åŒºåŸŸ -->
    <view class="header-info">
      <text class="current-class">å½“å‰ç­çº§ï¼š{{currentClassName}}</text>
      <text class="assignment-count">å…±{{assignments.length}}ä¸ªä½œä¸š</text>
    </view>
    <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
    <view class="header-actions">
      <button class="btn-primary" bindtap="showAddModal">æ–°å»ºä½œä¸š</button>
    </view>
  </view>

  <!-- ä½œä¸šåˆ—è¡¨ -->
  <view class="assignment-list" wx:if="{{assignments.length > 0}}">
    <view class="assignment-item" wx:for="{{assignments}}" wx:key="id">
      <view class="assignment-info">
        <view class="assignment-name">{{item.name}}</view>
        <view class="assignment-meta">
          <text class="assignment-type">{{item.type}}</text>
          <text class="assignment-questions">{{item.questionCount}}é¢˜</text>
          <text class="assignment-date">{{item.createdAt}}</text>
        </view>
        <view class="assignment-stats" wx:if="{{item.stats}}">
          <text class="stat-item">å·²æ‰¹æ”¹ï¼š{{item.stats.gradedCount}}/{{item.stats.totalCount}}</text>
          <text class="stat-item">å¹³å‡åˆ†ï¼š{{item.stats.averageScore}}</text>
        </view>
      </view>
      <view class="assignment-actions">
        <button class="btn-primary" data-id="{{item.id}}" bindtap="gradeAssignment">æ‰¹æ”¹</button>
        <button class="btn-secondary" data-id="{{item.id}}" bindtap="viewAssignment">æŸ¥çœ‹</button>
        <button class="btn-secondary" data-id="{{item.id}}" bindtap="editQuestions">ç¼–è¾‘é¢˜ç›®</button>
        <button class="btn-secondary" data-id="{{item.id}}" bindtap="editAssignment">ç¼–è¾‘ä¿¡æ¯</button>
        <button class="btn-danger" data-id="{{item.id}}" bindtap="deleteAssignment">åˆ é™¤</button>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:else>
    <text class="empty-text">æš‚æ— ä½œä¸š</text>
    <button class="btn-primary" bindtap="showAddModal">åˆ›å»ºç¬¬ä¸€ä¸ªä½œä¸š</button>
  </view>

  <!-- æ–°å»º/ç¼–è¾‘ä½œä¸šå¼¹çª— -->
  <view class="modal" wx:if="{{showModal}}" bindtap="hideModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{isEdit ? 'ç¼–è¾‘ä½œä¸š' : 'æ–°å»ºä½œä¸š'}}</text>
        <text class="modal-close" bindtap="hideModal">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="form-group">
          <label class="form-label">ä½œä¸šåç§°</label>
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥ä½œä¸šåç§°"
            value="{{formData.name}}"
            data-field="name"
            bindinput="onInputChange"
          />
        </view>

        <view class="form-group">
          <label class="form-label">ä½œä¸šç±»å‹</label>
          <picker 
            mode="selector" 
            range="{{assignmentTypes}}" 
            value="{{formData.typeIndex}}"
            bindchange="onTypeChange"
          >
            <view class="picker-display">
              {{formData.typeIndex >= 0 ? assignmentTypes[formData.typeIndex] : 'è¯·é€‰æ‹©ä½œä¸šç±»å‹'}}
            </view>
          </picker>
        </view>

        <!-- Markdownå¯¼å…¥åŠŸèƒ½ -->
        <view class="form-group">
          <label class="form-label">å¿«é€Ÿå¯¼å…¥</label>
          <view class="import-section">
            <view class="import-options">
              <button class="btn-import" bindtap="importFromMarkdown">
                <text class="import-icon">ğŸ“„</text>
                <text class="import-text">ä»Markdownæ–‡ä»¶å¯¼å…¥</text>
              </button>
              <text class="import-hint">æ”¯æŒå¯¼å…¥ç»“æ„åŒ–çš„é¢˜ç›®å’ŒçŸ¥è¯†ç‚¹</text>
            </view>
            
            <!-- Markdownå¯¼å…¥é¢„è§ˆ -->
            <view class="import-preview" wx:if="{{importPreview.show}}">
              <view class="preview-header">
                <text class="preview-title">å¯¼å…¥é¢„è§ˆ</text>
                <button class="btn-close-preview" bindtap="closeImportPreview">Ã—</button>
              </view>
              <view class="preview-content">
                <view class="preview-summary">
                  <text class="summary-item">å¤§é¢˜ï¼š{{importPreview.summary.level1Count}}ä¸ª</text>
                  <text class="summary-item">å°é¢˜ï¼š{{importPreview.summary.level2Count}}ä¸ª</text>
                  <text class="summary-item">ç»†åˆ†é¢˜ï¼š{{importPreview.summary.level3Count}}ä¸ª</text>
                  <text class="summary-item">æ€»åˆ†ï¼š{{importPreview.totalScore}}åˆ†</text>
                  <text class="summary-item">çŸ¥è¯†ç‚¹ï¼š{{importPreview.summary.knowledgePointsCount}}ä¸ª</text>
                </view>
                <view class="preview-actions">
                  <button class="btn-secondary" bindtap="closeImportPreview">å–æ¶ˆ</button>
                  <button class="btn-primary" bindtap="confirmImport">ç¡®è®¤å¯¼å…¥</button>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- ä¸‰çº§é¢˜ç›®ç»“æ„é…ç½® -->
        <view class="form-group">
          <label class="form-label">é¢˜ç›®ç»“æ„é…ç½®</label>
          <view class="question-structure-config">
            
            <!-- ä¸€çº§é¢˜ç›®ï¼ˆå¤§é¢˜ï¼‰é…ç½® -->
            <view class="level-config level-1">
              <view class="level-header">
                <text class="level-title">ä¸€çº§é¢˜ç›®ï¼ˆå¤§é¢˜ï¼‰</text>
                <button class="btn-add" bindtap="addLevel1Question">+ æ·»åŠ å¤§é¢˜</button>
              </view>
              
              <view class="question-list" wx:if="{{formData.questionStructure.length > 0}}">
                <view class="question-item level-1-item" wx:for="{{formData.questionStructure}}" wx:key="index" wx:for-index="level1Index">
                  <view class="question-header">
                    <text class="question-title">ç¬¬{{level1Index + 1}}å¤§é¢˜</text>
                    <view class="question-controls">
                      <!-- ä¸€çº§é¢˜ç›®æ˜¾ç¤ºè®¡ç®—å‡ºçš„åˆ†æ•°ï¼Œä¸å…è®¸æ‰‹åŠ¨è¾“å…¥ -->
                      <view class="score-display">
                        <text class="calculated-score">{{item.calculatedScore || 0}}</text>
                        <text class="score-unit">åˆ†</text>
                        <text class="score-hint">ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</text>
                      </view>
                      <button class="btn-delete" data-level1="{{level1Index}}" bindtap="deleteLevel1Question">åˆ é™¤</button>
                    </view>
                  </view>
                  
                  <!-- äºŒçº§é¢˜ç›®ï¼ˆå°é¢˜ï¼‰é…ç½® -->
                  <view class="level-config level-2">
                    <view class="level-header">
                      <text class="level-title">äºŒçº§é¢˜ç›®ï¼ˆå°é¢˜ï¼‰</text>
                      <view class="header-buttons">
                        <button class="btn-batch" wx:if="{{item.subQuestions && item.subQuestions.length > 1}}" data-level1="{{level1Index}}" bindtap="showBatchSetLevel2Score">æ‰¹é‡è®¾åˆ†</button>
                        <button class="btn-add" data-level1="{{level1Index}}" bindtap="addLevel2Question">+ æ·»åŠ å°é¢˜</button>
                      </view>
                    </view>
                    
                    <view class="question-list" wx:if="{{item.subQuestions && item.subQuestions.length > 0}}">
                      <view class="question-item level-2-item" wx:for="{{item.subQuestions}}" wx:key="index" wx:for-index="level2Index">
                        <view class="question-header">
                          <text class="question-title">ç¬¬{{level2Index + 1}}å°é¢˜</text>
                          <view class="question-controls">
                            <!-- å¦‚æœæœ‰ä¸‰çº§é¢˜ç›®ï¼Œæ˜¾ç¤ºè®¡ç®—åˆ†æ•°ï¼›å¦‚æœæ²¡æœ‰ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡† -->
                            <view wx:if="{{item.subQuestions && item.subQuestions.length > 0}}" class="score-display">
                              <text class="calculated-score">{{item.calculatedScore || 0}}</text>
                              <text class="score-unit">åˆ†</text>
                              <text class="score-hint">ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</text>
                            </view>
                            <view wx:else class="score-input-group">
                              <input 
                                class="score-input" 
                                type="number" 
                                placeholder="åˆ†æ•°"
                                value="{{item.score}}"
                                data-level1="{{level1Index}}"
                                data-level2="{{level2Index}}"
                                bindinput="onLevel2ScoreChange"
                              />
                              <text class="score-unit">åˆ†</text>
                            </view>
                            <button class="btn-delete" data-level1="{{level1Index}}" data-level2="{{level2Index}}" bindtap="deleteLevel2Question">åˆ é™¤</button>
                          </view>
                        </view>
                        
                        <!-- ä¸‰çº§é¢˜ç›®ï¼ˆç»†åˆ†é¢˜ï¼‰é…ç½® -->
                        <view class="level-config level-3">
                          <text class="level-title">ä¸‰çº§é¢˜ç›®ï¼ˆç»†åˆ†é¢˜ï¼‰</text>
                          <view class="level-header">
                            <view class="header-buttons">
                              <button class="btn-batch" wx:if="{{item.subQuestions && item.subQuestions.length > 1}}" data-level1="{{level1Index}}" data-level2="{{level2Index}}" bindtap="showBatchSetLevel3Score">æ‰¹é‡è®¾åˆ†</button>
                              <button class="btn-add" data-level1="{{level1Index}}" data-level2="{{level2Index}}" bindtap="addLevel3Question">+ æ·»åŠ ç»†åˆ†é¢˜</button>
                            </view>
                          </view>
                          
                          <view class="question-list" wx:if="{{item.subQuestions && item.subQuestions.length > 0}}">
                            <view class="question-item level-3-item" wx:for="{{item.subQuestions}}" wx:key="index" wx:for-index="level3Index">
                              <text class="question-title">ç¬¬{{level3Index + 1}}ç»†åˆ†é¢˜</text>
                              <view class="question-header">
                                <view class="question-controls">
                                  <input 
                                    class="score-input" 
                                    type="number" 
                                    placeholder="åˆ†æ•°"
                                    value="{{item.score}}"
                                    data-level1="{{level1Index}}"
                                    data-level2="{{level2Index}}"
                                    data-level3="{{level3Index}}"
                                    bindinput="onLevel3ScoreChange"
                                  />
                                  <text class="score-unit">åˆ†</text>
                                  <button class="btn-delete" data-level1="{{level1Index}}" data-level2="{{level2Index}}" data-level3="{{level3Index}}" bindtap="deleteLevel3Question">åˆ é™¤</button>
                                </view>
                              </view>
                            </view>
                          </view>
                        </view>
                      </view>
                    </view>
                  </view>
                </view>
              </view>
              
              <!-- ç©ºçŠ¶æ€æç¤º -->
              <view class="empty-hint" wx:if="{{formData.questionStructure.length === 0}}">
                <text>è¯·ç‚¹å‡»"æ·»åŠ å¤§é¢˜"å¼€å§‹é…ç½®é¢˜ç›®ç»“æ„</text>
              </view>
            </view>
            
            <!-- æ€»åˆ†æ˜¾ç¤º -->
            <view class="total-score-display">
              <text class="total-label">æ€»åˆ†ï¼š</text>
              <text class="total-value">{{totalScore}}</text>
              <text class="total-unit">åˆ†</text>
            </view>
          </view>
        </view>

        <!-- è¯„åˆ†é€‰é¡¹ -->
        <view class="form-group">
          <label class="form-label">è¯„åˆ†æ–¹å¼</label>
          <radio-group bindchange="onScoringModeChange">
            <label class="radio-item">
              <radio value="standard" checked="{{formData.scoringMode === 'standard'}}"/>
              <text>æ ‡å‡†è¯„åˆ†ï¼ˆå¯¹é”™ï¼‰</text>
            </label>
            <label class="radio-item">
              <radio value="custom" checked="{{formData.scoringMode === 'custom'}}"/>
              <text>è‡ªå®šä¹‰åˆ†å€¼</text>
            </label>
          </radio-group>
        </view>

        <!-- è‡ªå®šä¹‰åˆ†å€¼é…ç½® -->
        <view class="custom-scoring-config" wx:if="{{formData.scoringMode === 'custom'}}">
          <label class="form-label">å„é¢˜åˆ†å€¼ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
          <input 
            class="form-input" 
            placeholder="ä¾‹å¦‚ï¼š10,15,20"
            value="{{formData.customScoresText}}"
            data-field="customScoresText"
            bindinput="onInputChange"
          />
          <text class="form-hint">ç¬¬1é¢˜10åˆ†ï¼Œç¬¬2é¢˜15åˆ†ï¼Œç¬¬3é¢˜20åˆ†</text>
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn-secondary" bindtap="hideModal">å–æ¶ˆ</button>
        <button class="btn-primary" bindtap="handleSubmit">{{isEdit ? 'æ›´æ–°' : 'åˆ›å»º'}}</button>
      </view>
    </view>
  </view>
</view>

<!-- æ‰¹é‡è®¾ç½®åˆ†æ•°å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showBatchScoreModal}}" bindtap="hideBatchScoreModal">
  <view class="modal-content batch-score-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">æ‰¹é‡è®¾ç½®åˆ†æ•°</text>
      <text class="modal-subtitle">{{batchScoreConfig.title}}</text>
    </view>
    
    <view class="modal-body">
      <!-- è®¾ç½®æ¨¡å¼é€‰æ‹© -->
      <view class="form-group">
        <label class="form-label">è®¾ç½®æ¨¡å¼</label>
        <radio-group bindchange="onBatchModeChange">
          <label class="radio-item">
            <radio value="uniform" checked="{{batchScoreConfig.mode === 'uniform'}}"/>
            <text>ç»Ÿä¸€åˆ†æ•°</text>
          </label>
          <label class="radio-item">
            <radio value="individual" checked="{{batchScoreConfig.mode === 'individual'}}"/>
            <text>åˆ†åˆ«è®¾ç½®</text>
          </label>
        </radio-group>
      </view>

      <!-- ç»Ÿä¸€åˆ†æ•°æ¨¡å¼ -->
      <view class="form-group" wx:if="{{batchScoreConfig.mode === 'uniform'}}">
        <label class="form-label">ç»Ÿä¸€åˆ†æ•°</label>
        <view class="score-input-group">
          <input 
            class="form-input score-input" 
            type="number" 
            placeholder="è¯·è¾“å…¥åˆ†æ•°"
            value="{{batchScoreConfig.uniformScore}}"
            data-field="uniformScore"
            bindinput="onBatchScoreInputChange"
          />
          <text class="score-unit">åˆ†</text>
        </view>
      </view>

      <!-- åˆ†åˆ«è®¾ç½®æ¨¡å¼ -->
      <view class="form-group" wx:if="{{batchScoreConfig.mode === 'individual'}}">
        <label class="form-label">åˆ†åˆ«è®¾ç½®åˆ†æ•°</label>
        <view class="individual-scores">
          <view class="score-item" wx:for="{{batchScoreConfig.questions}}" wx:key="index">
            <text class="question-label">{{item.label}}</text>
            <view class="score-input-group">
              <input 
                class="form-input score-input" 
                type="number" 
                placeholder="åˆ†æ•°"
                value="{{item.score}}"
                data-index="{{index}}"
                bindinput="onIndividualScoreChange"
              />
              <text class="score-unit">åˆ†</text>
            </view>
          </view>
        </view>
      </view>

      <!-- é¢„è§ˆæ€»åˆ† -->
      <view class="form-group">
        <label class="form-label">é¢„è§ˆæ€»åˆ†</label>
        <text class="total-preview">{{batchScoreConfig.totalPreview}}åˆ†</text>
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn-secondary" bindtap="hideBatchScoreModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="confirmBatchSetScore">ç¡®è®¤è®¾ç½®</button>
    </view>
  </view>
</view>